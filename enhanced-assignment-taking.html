<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Assignment Taking - IG Nation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.7/dist/iconify-icon.min.css">
    <style>
        * {
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #F8F8F8;
            min-height: 100vh;
        }
        
        .assignment-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            padding: 0.5rem;
            border-radius: 8px;
            margin: 0.5rem 0;
        }
        
        .timer-warning {
            background-color: #ff9800;
            color: white;
        }
        
        .timer-danger {
            background-color: #f44336;
            color: white;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .main-content {
            padding: 2rem;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .assignment-info {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        
        .assignment-title {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 1rem;
        }
        
        .assignment-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .meta-icon {
            font-size: 1.2rem;
            color: #667eea;
        }
        
        .meta-text {
            font-weight: 600;
            color: #333;
        }
        
        .question-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        
        .question-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f8f9fa;
        }
        
        .question-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .question-type-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .type-text {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .type-file {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .type-multiple-choice {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        .question-content {
            margin-bottom: 2rem;
        }
        
        .question-text {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #333;
            margin-bottom: 1rem;
        }
        
        .question-files {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .file-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .file-icon {
            font-size: 1.2rem;
            color: #667eea;
        }
        
        .file-name {
            font-weight: 600;
            color: #333;
        }
        
        .file-size {
            font-size: 0.8rem;
            color: #666;
        }
        
        .answer-section {
            margin-top: 1.5rem;
        }
        
        .answer-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .answer-icon {
            font-size: 1.3rem;
            color: #28a745;
        }
        
        .text-answer {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            resize: vertical;
            transition: all 0.3s ease;
        }
        
        .text-answer:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            outline: none;
        }
        
        .file-upload-area {
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8f9fa;
        }
        
        .file-upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .file-upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .upload-text {
            color: #666;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .upload-hint {
            color: #999;
            font-size: 0.9rem;
        }
        
        .multiple-choice-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .option-item:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .option-item.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }
        
        .option-radio {
            margin: 0;
            transform: scale(1.2);
        }
        
        .option-text {
            flex: 1;
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }
        
        .uploaded-files {
            margin-top: 1rem;
        }
        
        .uploaded-file {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .uploaded-file-icon {
            font-size: 1.2rem;
            color: #388e3c;
        }
        
        .uploaded-file-name {
            flex: 1;
            font-weight: 600;
            color: #333;
        }
        
        .remove-file {
            background: #dc3545;
            border: none;
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }
        
        .remove-file:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .submit-section {
            position: sticky;
            bottom: 0;
            background: white;
            border-top: 1px solid #e0e0e0;
            padding: 2rem;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }
        
        .progress-section {
            margin-bottom: 1.5rem;
        }
        
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: #e9ecef;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 0.5rem;
            font-weight: 600;
            color: #666;
        }
        
        .submit-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 1rem 2rem;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
            border: none;
            border-radius: 8px;
            padding: 1rem 2rem;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 8px;
            padding: 1rem 2rem;
            color: white;
            font-weight: 600;
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }
        
        .time-expired-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .time-expired-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .time-expired-icon {
            font-size: 4rem;
            color: #dc3545;
            margin-bottom: 1rem;
        }
        
        .time-expired-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 1rem;
        }
        
        .time-expired-text {
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.5;
        }
        
        .hidden {
            display: none;
        }
        
        .file-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        .file-preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .file-preview-pdf {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
    </style>
</head>
<body>
    <div class="assignment-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0">Enhanced Assignment Taking</h1>
                    <p class="mb-0 opacity-75">Interactive question answering with multiple formats</p>
                </div>
                <div class="timer-display" id="timerDisplay">
                    Time: <span id="timeLeft">02:00:00</span>
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <!-- Assignment Information -->
        <div class="assignment-info">
            <h2 class="assignment-title" id="assignmentTitle">Mathematics Assignment - Algebra Basics</h2>
            <div class="assignment-meta">
                <div class="meta-item">
                    <iconify-icon icon="material-symbols:school" class="meta-icon"></iconify-icon>
                    <span class="meta-text">Course: <span id="courseName">Mathematics</span></span>
                </div>
                <div class="meta-item">
                    <iconify-icon icon="material-symbols:schedule" class="meta-icon"></iconify-icon>
                    <span class="meta-text">Due: <span id="dueDate">Dec 30, 2024</span></span>
                </div>
                <div class="meta-item">
                    <iconify-icon icon="material-symbols:quiz" class="meta-icon"></iconify-icon>
                    <span class="meta-text">Questions: <span id="totalQuestions">5</span></span>
                </div>
                <div class="meta-item">
                    <iconify-icon icon="material-symbols:star" class="meta-icon"></iconify-icon>
                    <span class="meta-text">Points: <span id="totalPoints">50</span></span>
                </div>
            </div>
        </div>

        <!-- Questions Container -->
        <div id="questionsContainer">
            <!-- Questions will be dynamically loaded here -->
        </div>

        <!-- Submit Section -->
        <div class="submit-section">
            <div class="progress-section">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">0 of 5 questions answered</div>
            </div>
            
            <div class="submit-buttons">
                <button class="btn btn-secondary" onclick="saveProgress()">
                    <iconify-icon icon="material-symbols:save"></iconify-icon>
                    Save Progress
                </button>
                <button class="btn btn-primary" onclick="submitAssignment()" id="submitBtn">
                    <iconify-icon icon="material-symbols:send"></iconify-icon>
                    Submit Assignment
                </button>
            </div>
        </div>
    </div>

    <!-- Time Expired Modal -->
    <div class="time-expired-modal hidden" id="timeExpiredModal">
        <div class="time-expired-content">
            <iconify-icon icon="material-symbols:schedule" class="time-expired-icon"></iconify-icon>
            <h3 class="time-expired-title">Time's Up!</h3>
            <p class="time-expired-text">
                Your time for this assignment has expired. Your current answers will be automatically submitted.
            </p>
            <button class="btn btn-success" onclick="autoSubmit()">
                <iconify-icon icon="material-symbols:send"></iconify-icon>
                Submit Now
            </button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="js/question-system.js"></script>
    <script>
        let currentAssignment = null;
        let currentQuestions = [];
        let studentAnswers = {};
        let timeRemaining = 7200; // 2 hours in seconds
        let timerInterval = null;
        let currentStudentId = 'ST001'; // This would come from authentication

        // Sample assignment data
        const sampleAssignment = {
            id: 'assignment_1',
            title: 'Mathematics Assignment - Algebra Basics',
            course: 'mathematics',
            dueDate: '2024-12-30',
            totalQuestions: 5,
            totalPoints: 50,
            timeLimit: 7200, // 2 hours
            questions: [
                {
                    id: 'q_1',
                    questionType: 'text',
                    content: 'Solve for x: 2x + 5 = 15',
                    answerFormat: 'text',
                    maxGrade: 10,
                    files: []
                },
                {
                    id: 'q_2',
                    questionType: 'file',
                    content: 'Explain the concept of quadratic equations and provide examples. You may include diagrams or graphs.',
                    answerFormat: 'file',
                    maxGrade: 15,
                    files: [
                        {
                            name: 'quadratic_examples.pdf',
                            size: 1024000,
                            type: 'application/pdf'
                        }
                    ]
                },
                {
                    id: 'q_3',
                    questionType: 'multiple-choice',
                    content: 'What is the solution to the equation 3x - 7 = 14?',
                    maxGrade: 5,
                    options: [
                        { id: 0, text: 'x = 7', isCorrect: true },
                        { id: 1, text: 'x = 21', isCorrect: false },
                        { id: 2, text: 'x = 3', isCorrect: false },
                        { id: 3, text: 'x = 9', isCorrect: false }
                    ],
                    correctAnswer: 0,
                    explanation: 'Add 7 to both sides: 3x = 21, then divide by 3: x = 7'
                },
                {
                    id: 'q_4',
                    questionType: 'text',
                    content: 'A rectangle has a length of (2x + 3) cm and a width of (x - 1) cm. Write an expression for the area of the rectangle.',
                    answerFormat: 'text',
                    maxGrade: 10,
                    files: []
                },
                {
                    id: 'q_5',
                    questionType: 'file',
                    content: 'Create a graph showing the relationship y = 2x + 1. Upload your graph as an image.',
                    answerFormat: 'file',
                    maxGrade: 10,
                    files: [],
                    acceptedFileTypes: ['image']
                }
            ]
        };

        document.addEventListener('DOMContentLoaded', function() {
            loadAssignment();
            startTimer();
            updateProgress();
        });

        function loadAssignment() {
            currentAssignment = sampleAssignment;
            currentQuestions = currentAssignment.questions;
            
            // Update assignment info
            document.getElementById('assignmentTitle').textContent = currentAssignment.title;
            document.getElementById('courseName').textContent = currentAssignment.course;
            document.getElementById('dueDate').textContent = new Date(currentAssignment.dueDate).toLocaleDateString();
            document.getElementById('totalQuestions').textContent = currentAssignment.totalQuestions;
            document.getElementById('totalPoints').textContent = currentAssignment.totalPoints;
            
            // Load saved answers
            const savedAnswers = localStorage.getItem(`assignment_${currentAssignment.id}_answers`);
            if (savedAnswers) {
                studentAnswers = JSON.parse(savedAnswers);
            }
            
            displayQuestions();
        }

        function displayQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            currentQuestions.forEach((question, index) => {
                const questionCard = createQuestionCard(question, index + 1);
                container.appendChild(questionCard);
            });
        }

        function createQuestionCard(question, questionNumber) {
            const card = document.createElement('div');
            card.className = 'question-card';
            card.id = `question_${question.id}`;

            let typeBadge = '';
            let typeClass = '';
            switch (question.questionType) {
                case 'text':
                    typeBadge = 'Text Answer';
                    typeClass = 'type-text';
                    break;
                case 'file':
                    typeBadge = 'File Upload';
                    typeClass = 'type-file';
                    break;
                case 'multiple-choice':
                    typeBadge = 'Multiple Choice';
                    typeClass = 'type-multiple-choice';
                    break;
            }

            card.innerHTML = `
                <div class="question-header">
                    <div class="question-number">${questionNumber}</div>
                    <span class="question-type-badge ${typeClass}">${typeBadge}</span>
                </div>
                
                <div class="question-content">
                    <div class="question-text">${question.content}</div>
                    ${question.files && question.files.length > 0 ? `
                        <div class="question-files">
                            ${question.files.map(file => `
                                <div class="file-item">
                                    <iconify-icon icon="material-symbols:description" class="file-icon"></iconify-icon>
                                    <span class="file-name">${file.name}</span>
                                    <span class="file-size">(${(file.size / 1024).toFixed(1)} KB)</span>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <div class="answer-section">
                    <div class="answer-title">
                        <iconify-icon icon="material-symbols:edit" class="answer-icon"></iconify-icon>
                        Your Answer
                    </div>
                    ${getAnswerInputHTML(question)}
                </div>
            `;

            // Load saved answer
            if (studentAnswers[question.id]) {
                loadSavedAnswer(question, studentAnswers[question.id]);
            }

            return card;
        }

        function getAnswerInputHTML(question) {
            switch (question.questionType) {
                case 'text':
                    return `
                        <textarea class="text-answer" id="answer_${question.id}" 
                                  placeholder="Enter your answer here..." 
                                  oninput="saveAnswer('${question.id}', this.value)"></textarea>
                    `;
                
                case 'file':
                    return `
                        <div class="file-upload-area" onclick="document.getElementById('file_${question.id}').click()" 
                             ondrop="handleFileDrop(event, '${question.id}')" 
                             ondragover="handleDragOver(event)" 
                             ondragleave="handleDragLeave(event)">
                            <iconify-icon icon="material-symbols:cloud-upload" class="upload-icon"></iconify-icon>
                            <div class="upload-text">Click to upload or drag files here</div>
                            <div class="upload-hint">Supports images, PDFs, and documents</div>
                        </div>
                        <input type="file" id="file_${question.id}" multiple 
                               accept="${getAcceptedFileTypes(question)}" 
                               style="display: none;" 
                               onchange="handleFileSelect(event, '${question.id}')">
                        <div class="uploaded-files" id="uploaded_files_${question.id}"></div>
                    `;
                
                case 'multiple-choice':
                    return `
                        <div class="multiple-choice-options">
                            ${question.options.map((option, index) => `
                                <div class="option-item" onclick="selectOption('${question.id}', ${index})">
                                    <input type="radio" name="answer_${question.id}" value="${index}" 
                                           class="option-radio" id="option_${question.id}_${index}">
                                    <label for="option_${question.id}_${index}" class="option-text">${option.text}</label>
                                </div>
                            `).join('')}
                        </div>
                    `;
                
                default:
                    return '<p>Unsupported question type</p>';
            }
        }

        function getAcceptedFileTypes(question) {
            if (question.acceptedFileTypes && question.acceptedFileTypes.length > 0) {
                const typeMap = {
                    'pdf': '.pdf',
                    'image': '.jpg,.jpeg,.png,.gif,.webp',
                    'document': '.doc,.docx'
                };
                return question.acceptedFileTypes.map(type => typeMap[type] || '').join(',');
            }
            return '.pdf,.jpg,.jpeg,.png,.gif,.doc,.docx';
        }

        function loadSavedAnswer(question, savedAnswer) {
            switch (question.questionType) {
                case 'text':
                    document.getElementById(`answer_${question.id}`).value = savedAnswer.text || '';
                    break;
                case 'file':
                    if (savedAnswer.files) {
                        displayUploadedFiles(question.id, savedAnswer.files);
                    }
                    break;
                case 'multiple-choice':
                    if (savedAnswer.selectedOption !== undefined) {
                        document.getElementById(`option_${question.id}_${savedAnswer.selectedOption}`).checked = true;
                        document.querySelector(`#option_${question.id}_${savedAnswer.selectedOption}`).closest('.option-item').classList.add('selected');
                    }
                    break;
            }
        }

        function saveAnswer(questionId, answer) {
            if (!studentAnswers[questionId]) {
                studentAnswers[questionId] = {};
            }
            
            const question = currentQuestions.find(q => q.id === questionId);
            switch (question.questionType) {
                case 'text':
                    studentAnswers[questionId].text = answer;
                    break;
                case 'file':
                    // File answers are handled separately
                    break;
                case 'multiple-choice':
                    studentAnswers[questionId].selectedOption = parseInt(answer);
                    break;
            }
            
            saveProgress();
            updateProgress();
        }

        function selectOption(questionId, optionIndex) {
            // Remove previous selection
            document.querySelectorAll(`input[name="answer_${questionId}"]`).forEach(radio => {
                radio.closest('.option-item').classList.remove('selected');
            });
            
            // Select new option
            const selectedRadio = document.getElementById(`option_${questionId}_${optionIndex}`);
            selectedRadio.checked = true;
            selectedRadio.closest('.option-item').classList.add('selected');
            
            saveAnswer(questionId, optionIndex);
        }

        function handleFileSelect(event, questionId) {
            const files = Array.from(event.target.files);
            handleFileUpload(questionId, files);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('dragover');
        }

        function handleFileDrop(event, questionId) {
            event.preventDefault();
            event.currentTarget.classList.remove('dragover');
            const files = Array.from(event.dataTransfer.files);
            handleFileUpload(questionId, files);
        }

        function handleFileUpload(questionId, files) {
            if (!studentAnswers[questionId]) {
                studentAnswers[questionId] = {};
            }
            if (!studentAnswers[questionId].files) {
                studentAnswers[questionId].files = [];
            }
            
            files.forEach(file => {
                const fileData = {
                    id: Date.now() + Math.random(),
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    file: file
                };
                studentAnswers[questionId].files.push(fileData);
            });
            
            displayUploadedFiles(questionId, studentAnswers[questionId].files);
            saveProgress();
            updateProgress();
        }

        function displayUploadedFiles(questionId, files) {
            const container = document.getElementById(`uploaded_files_${questionId}`);
            container.innerHTML = '';
            
            files.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'uploaded-file';
                fileItem.innerHTML = `
                    <iconify-icon icon="material-symbols:description" class="uploaded-file-icon"></iconify-icon>
                    <span class="uploaded-file-name">${file.name}</span>
                    <button type="button" class="remove-file" onclick="removeFile('${questionId}', '${file.id}')">×</button>
                `;
                container.appendChild(fileItem);
            });
        }

        function removeFile(questionId, fileId) {
            if (studentAnswers[questionId] && studentAnswers[questionId].files) {
                studentAnswers[questionId].files = studentAnswers[questionId].files.filter(f => f.id != fileId);
                displayUploadedFiles(questionId, studentAnswers[questionId].files);
                saveProgress();
                updateProgress();
            }
        }

        function saveProgress() {
            localStorage.setItem(`assignment_${currentAssignment.id}_answers`, JSON.stringify(studentAnswers));
        }

        function updateProgress() {
            const answeredCount = Object.keys(studentAnswers).filter(questionId => {
                const answer = studentAnswers[questionId];
                const question = currentQuestions.find(q => q.id === questionId);
                
                switch (question.questionType) {
                    case 'text':
                        return answer.text && answer.text.trim().length > 0;
                    case 'file':
                        return answer.files && answer.files.length > 0;
                    case 'multiple-choice':
                        return answer.selectedOption !== undefined;
                    default:
                        return false;
                }
            }).length;
            
            const progressPercent = (answeredCount / currentQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progressPercent + '%';
            document.getElementById('progressText').textContent = 
                `${answeredCount} of ${currentQuestions.length} questions answered`;
            
            // Update submit button state
            const submitBtn = document.getElementById('submitBtn');
            if (answeredCount === currentQuestions.length) {
                submitBtn.classList.remove('btn-primary');
                submitBtn.classList.add('btn-success');
                submitBtn.innerHTML = '<iconify-icon icon="material-symbols:send"></iconify-icon> Ready to Submit';
            } else {
                submitBtn.classList.remove('btn-success');
                submitBtn.classList.add('btn-primary');
                submitBtn.innerHTML = '<iconify-icon icon="material-symbols:send"></iconify-icon> Submit Assignment';
            }
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    showTimeExpiredModal();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const hours = Math.floor(timeRemaining / 3600);
            const minutes = Math.floor((timeRemaining % 3600) / 60);
            const seconds = timeRemaining % 60;
            
            const timeString = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('timeLeft').textContent = timeString;
            
            const timerDisplay = document.getElementById('timerDisplay');
            if (timeRemaining <= 300) { // 5 minutes
                timerDisplay.classList.add('timer-danger');
            } else if (timeRemaining <= 900) { // 15 minutes
                timerDisplay.classList.add('timer-warning');
            }
        }

        function showTimeExpiredModal() {
            document.getElementById('timeExpiredModal').classList.remove('hidden');
        }

        function autoSubmit() {
            submitAssignment();
        }

        function submitAssignment() {
            // Create submission using the question system
            const questionSystem = getQuestionSystem(currentAssignment.course);
            
            currentQuestions.forEach(question => {
                const answer = studentAnswers[question.id];
                if (answer) {
                    let studentAnswerText = '';
                    let studentFiles = [];
                    
                    switch (question.questionType) {
                        case 'text':
                            studentAnswerText = answer.text || '';
                            break;
                        case 'file':
                            studentAnswerText = 'File submission';
                            studentFiles = answer.files || [];
                            break;
                        case 'multiple-choice':
                            if (answer.selectedOption !== undefined) {
                                studentAnswerText = question.options[answer.selectedOption].text;
                            }
                            break;
                    }
                    
                    if (studentAnswerText) {
                        questionSystem.submitAnswer(question.id, currentStudentId, studentAnswerText, studentFiles);
                    }
                }
            });
            
            // Clear saved answers
            localStorage.removeItem(`assignment_${currentAssignment.id}_answers`);
            
            // Show success message
            alert('Assignment submitted successfully!');
            
            // Redirect or show results
            window.location.href = 'assignment-results.html';
        }
    </script>
</body>
</html>












