# Cart Issue Debugging Guide

## Expected Flow

### Step 1: User clicks "Enroll Now" on homenocourses.html

**Expected Console Output:**
```
ðŸŸ¢ ============ ENROLL IN COURSE STARTED ============
ðŸŸ¢ Course ID: 1
ðŸŸ¢ Current cart BEFORE enroll: []
ðŸŸ¢ localStorage cart BEFORE enroll: null (or previous cart)
Looking for course with ID: 1
Available courses: [{...course objects...}]
Found course: {title: "Mathematics IGCSE", ...}
Prepared course data: {courseId: 1, title: "Mathematics IGCSE", ...}
âœ… Cart updated with course data: [{...}]
âœ… Cart JSON stored: "[{...}]"
âœ… Verifying cart in localStorage: "[{...}]"
âœ… Backup course data stored in enrollCourse
ðŸŸ¢ ============ ABOUT TO REDIRECT ============
ðŸŸ¢ Final cart value: [{...}]
ðŸŸ¢ Final localStorage cart: "[{...}]"
ðŸŸ¢ Final localStorage enrollCourse: "{...}"
ðŸŸ¢ Redirect URL: checkout.html?course=1
ðŸŸ¢ ============ REDIRECTING NOW ============
```

### Step 2: Checkout page loads

**Expected Console Output:**
```
ðŸ”µ CHECKOUT PAGE: Starting cart initialization...
ðŸ”µ localStorage.getItem("cart"): "[{...}]"
ðŸ”µ localStorage.getItem("enrollCourse"): "{...}"
ðŸ›’ Cart loaded from localStorage: [{...}]
ðŸ›’ Cart length: 1
ðŸ›’ Cart contents: [{...}]
ðŸ”µ DOMContentLoaded event fired
ðŸ”µ Current URL: http://localhost:3000/checkout.html?course=1
ðŸ”µ URL Parameters: course=1
ðŸ”µ Cart at DOMContentLoaded: [{...}]
ðŸ”µ Cart from localStorage: [{...}]
```

### Step 3: User submits order

**Expected Console Output:**
```
ðŸ“‹ Preparing order from cart: [{...}]
ðŸ“‹ Cart length: 1
ðŸ“‹ Cart items: [{courseId: 1, title: "Mathematics IGCSE", ...}]
ðŸ” Processing cart item 1: {...}
âœ… Simple course data: {...}
ðŸ“¦ Courses prepared for order: [{...}]
âœ… Using courses directly: 1
ðŸ’¾ Saving order to database: {...}
   Courses JSON: "[{...}]"
   Courses parsed: [{...}]
âœ… Order ID: 14
âœ… Courses in order: [{...}]
âœ… Saved to lastOrder: {...}
âœ… Saved to lastPurchasedCart: [{...}]
```

### Step 4: Order processing page loads

**Expected Console Output:**
```
ðŸ”´ ============ ORDER PROCESSING PAGE LOADED ============
ðŸ”´ localStorage.cart: "[{...}]"
ðŸ”´ localStorage.enrollCourse: null (or "{...}")
ðŸ”´ localStorage.lastPurchasedCart: "[{...}]"
ðŸ”´ localStorage.lastOrder: "{...with courses...}"
ðŸ”´ ============================================
```

## Problem Diagnosis

### If cart is empty in Step 2:
- **Symptom**: `ðŸ”µ localStorage.getItem("cart"): null` or `"[]"`
- **Possible Causes**:
  1. LocalStorage is not persisting between pages
  2. Cart is being cleared by another script
  3. Browser privacy settings preventing localStorage

### If cart is empty in Step 3:
- **Symptom**: `ðŸ“‹ Cart length: 0`
- **Possible Causes**:
  1. Cart was never populated (check Step 1 logs)
  2. Cart was cleared between page load and submit
  3. Form submission is happening before cart is loaded

### If order has empty courses in database:
- **Symptom**: Order created but `courses: "[]"`
- **Possible Causes**:
  1. Cart was empty when order was submitted
  2. Course mapping logic failed
  3. validCourses array was empty

## Testing Steps

1. **Clear everything**:
   ```javascript
   localStorage.clear();
   ```

2. **Go to** `http://localhost:3000/homenocourses.html`

3. **Open Console** (F12)

4. **Click "Enroll Now"** on Mathematics

5. **DO NOT CLOSE CONSOLE** - keep it open through all pages

6. **On checkout page**, verify cart is loaded

7. **Fill out form** and submit

8. **On order-processing page**, check localStorage contents

## Manual Testing

Run these commands in browser console at each stage:

### Before clicking "Enroll Now":
```javascript
console.log('BEFORE ENROLL:');
console.log('cart:', localStorage.getItem('cart'));
console.log('enrollCourse:', localStorage.getItem('enrollCourse'));
```

### After clicking "Enroll Now" (on checkout page):
```javascript
console.log('ON CHECKOUT PAGE:');
console.log('cart:', localStorage.getItem('cart'));
console.log('enrollCourse:', localStorage.getItem('enrollCourse'));
console.log('Parsed cart:', JSON.parse(localStorage.getItem('cart') || '[]'));
```

### After submitting order (on order-processing page):
```javascript
console.log('ON ORDER PROCESSING PAGE:');
console.log('cart:', localStorage.getItem('cart'));
console.log('lastPurchasedCart:', localStorage.getItem('lastPurchasedCart'));
console.log('lastOrder:', localStorage.getItem('lastOrder'));
console.log('Parsed lastOrder:', JSON.parse(localStorage.getItem('lastOrder') || '{}'));
```

## Database Check

To see what's actually in the database:

```bash
cd backend
node -e "const sqlite3 = require('sqlite3').verbose(); const db = new sqlite3.Database('database.sqlite'); db.all('SELECT id, courses, customer_name FROM orders ORDER BY id DESC LIMIT 5', (err, rows) => { console.log(JSON.stringify(rows, null, 2)); db.close(); });"
```

## Quick Fix Test

If the issue persists, try this manual workaround:

1. Open `http://localhost:3000/test-localstorage.html`
2. Click "Test Enroll â†’ Checkout Flow"
3. This will:
   - Set cart in localStorage
   - Set enrollCourse backup
   - Redirect to checkout after 2 seconds
4. Check if cart persists to checkout page

If this works but the real flow doesn't, it means there's something in `homenocourses.html` that's interfering (like the periodic sync).

