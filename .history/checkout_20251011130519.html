<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Checkout - IG Way IGCSE Tutoring</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
  <link rel="stylesheet" type="text/css" href="css/vendor.css">
  <link rel="stylesheet" type="text/css" href="style.css?v=3">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@400;600;700&family=Roboto+Slab&display=swap"
    rel="stylesheet">
  <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
  <style>
    /* Override text-transform for all form inputs */
    input, textarea, select, .form-control, .form-select {
      text-transform: none !important;
    }
  </style>
</head>
<body>
  <!-- Top Utility Bar -->
  <div class="top-utility-bar" style="background:#fff; border-bottom:1px solid #eee; position:relative; height:60px;">
    <div class="container-fluid" style="position:relative; height:100%;">
      
      <!-- Centered Logo -->
      <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);">
        <a href="index.html">
          <img src="images/ig-nation-logo-graduation.png" alt="IG Nation" style="height:50px; width:auto;">
        </a>
      </div>

      <!-- Right-aligned Utility Links -->
      <div style="position:absolute; right:20px; top:50%; transform:translateY(-50%); display:flex; align-items:center; gap:20px; font-size:14px;">
        
        <!-- User Name Display -->
        <div id="userNameDisplay" style="display:none;">
          <span class="text-primary fw-bold" id="displayUserName">User</span>
          <a href="#" onclick="logout(); return false;" class="utility-link ms-2" style="text-decoration:none; color:#dc3545;">
            <iconify-icon icon="material-symbols:logout" style="margin-right:5px;"></iconify-icon>
            Logout
          </a>
        </div>

        <!-- Language Dropdown -->
        <div class="language-dropdown" style="position:relative;">
          <a href="#" class="utility-link" data-bs-toggle="dropdown" style="text-decoration:none; color:#000; display:flex; align-items:center;">
            Language <iconify-icon icon="material-symbols:keyboard-arrow-down" style="margin-left:5px;"></iconify-icon>
          </a>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="#">English</a></li>
            <li><a class="dropdown-item" href="#">العربية</a></li>
          </ul>
        </div>

        <!-- Cart Button -->
        <a href="#" class="utility-link" data-bs-toggle="modal" data-bs-target="#cartModal" style="text-decoration:none; color:#000; display:flex; align-items:center; position:relative;">
          <iconify-icon icon="material-symbols:shopping-cart" style="margin-right:5px;"></iconify-icon>
          Cart <span class="badge bg-primary ms-1" id="cartCount">0</span>
        </a>

        <!-- Favorites -->
        <a href="#" class="utility-link" data-bs-toggle="modal" data-bs-target="#favoritesModal" style="text-decoration:none; color:#000; display:flex; align-items:center;">
          <iconify-icon icon="material-symbols:favorite" style="margin-right:5px;"></iconify-icon>
          Favorites
        </a>
      </div>
    </div>
  </div>

  <!-- Main Navigation Bar -->
  <nav class="main-navigation">
    <div class="container-fluid">
      <div class="row align-items-center">
        <div class="col-7">
          <ul class="nav-menu d-flex list-unstyled mb-0">
            <li class="nav-item">
              <a href="index.html" class="nav-link">Home</a>
            </li>
            <li class="nav-item">
              <a href="courses.html" class="nav-link">Courses</a>
            </li>
            <li class="nav-item">
              <a href="about.html" class="nav-link">About Us</a>
            </li>
            <li class="nav-item">
              <a href="contact.html" class="nav-link">Contact Us</a>
            </li>
            <li class="nav-item">
              <!-- FAQ removed -->
            </li>
          </ul>
        </div>
        <div class="col-5">
          <div class="d-flex justify-content-end align-items-center gap-2">
            <a href="#" class="btn btn-outline-secondary login-btn" data-bs-toggle="modal" data-bs-target="#loginModal" style="font-size: 14px; padding: 8px 16px;">
              <iconify-icon icon="material-symbols:login" class="me-1"></iconify-icon>
              Login
            </a>
            <a href="#" class="btn btn-primary register-btn" data-bs-toggle="modal" data-bs-target="#registerModal" style="font-size: 14px; padding: 8px 16px;">
              <iconify-icon icon="material-symbols:person-add" class="me-1"></iconify-icon>
              Register Now
            </a>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Checkout Section -->
  <section class="checkout-section py-5" style="margin-top: 120px;">
    <div class="container">
      <div class="row">
        <div class="col-lg-8">
          <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
              <h3 class="mb-0">
                <iconify-icon icon="material-symbols:payment" class="me-2"></iconify-icon>
                Checkout Information
              </h3>
            </div>
            <div class="card-body p-4">
              <form id="checkoutForm">
                <!-- Personal Information -->
                <div class="mb-4">
                  <h5 class="text-primary mb-3">Personal Information</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group mb-3">
                        <label for="checkoutFirstName" class="form-label">First Name *</label>
                        <input type="text" class="form-control" id="checkoutFirstName" autocapitalize="none" autocorrect="off" spellcheck="false" required>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group mb-3">
                        <label for="checkoutLastName" class="form-label">Last Name *</label>
                        <input type="text" class="form-control" id="checkoutLastName" autocapitalize="none" autocorrect="off" spellcheck="false" required>
                      </div>
                    </div>
                  </div>
                  <div class="form-group mb-3">
                    <label for="checkoutEmail" class="form-label">Email Address *</label>
                    <input type="email" class="form-control" id="checkoutEmail" autocapitalize="none" autocorrect="off" spellcheck="false" required>
                  </div>
                  <div class="form-group mb-3">
                    <label for="checkoutPhone" class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="checkoutPhone" autocapitalize="none" autocorrect="off" spellcheck="false" required>
                  </div>
                </div>

                <!-- Payment Method -->
                <div class="mb-4">
                  <h5 class="text-primary mb-3">Payment Method</h5>
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-check payment-option">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="instapay" value="instapay">
                        <label class="form-check-label" for="instapay">
                          <div class="payment-card">
                            <iconify-icon icon="material-symbols:account-balance" class="fs-3 text-primary"></iconify-icon>
                            <div>
                              <strong>InstaPay</strong>
                              <small class="d-block text-muted">Bank Transfer</small>
                            </div>
                          </div>
                        </label>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-check payment-option">
                        <input class="form-check-input" type="radio" name="paymentMethod" id="vodafoneCash" value="vodafoneCash">
                        <label class="form-check-label" for="vodafoneCash">
                          <div class="payment-card">
                            <iconify-icon icon="material-symbols:phone-android" class="fs-3 text-success"></iconify-icon>
                            <div>
                              <strong>Vodafone Cash</strong>
                              <small class="d-block text-muted">Mobile Payment</small>
                            </div>
                          </div>
                        </label>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Payment Details -->
                <div class="mb-4" id="paymentDetails" style="display: none;">
                  <h5 class="text-primary mb-3">Payment Details</h5>
                  <div id="instapayDetails" class="payment-details" style="display: none;">
                    <div class="alert alert-info">
                      <h6>InstaPay Transfer Details:</h6>
                      <p><strong>Bank:</strong> National Bank of Egypt</p>
                      <p><strong>Account Name:</strong> IG Way Education</p>
                      <p><strong>Account Number:</strong> 1234567890</p>
                      <p><strong>Amount:</strong> <span id="instapayAmount"></span></p>
                    </div>
                  </div>
                  <div id="vodafoneCashDetails" class="payment-details" style="display: none;">
                    <div class="alert alert-success">
                      <h6>Vodafone Cash Details:</h6>
                      <p><strong>Phone Number:</strong> +201027500835</p>
                      <p><strong>Amount:</strong> <span id="vodafoneAmount"></span></p>
                    </div>
                  </div>
                </div>

                <!-- Payment Screenshot Upload -->
                <div class="mb-4" id="screenshotUpload" style="display: none;">
                  <h5 class="text-primary mb-3">
                    <iconify-icon icon="material-symbols:upload" class="me-2"></iconify-icon>
                    Upload Payment Screenshot
                  </h5>
                  <div class="form-group">
                    <label for="paymentScreenshot" class="form-label">Payment Screenshot *</label>
                    <input type="file" class="form-control" id="paymentScreenshot" accept="image/*" required>
                    <div class="form-text">
                      <iconify-icon icon="material-symbols:info" class="me-1"></iconify-icon>
                      Please upload a clear screenshot of your payment confirmation. This will be sent to WhatsApp for verification.
                    </div>
                    <div class="alert alert-warning mt-2">
                      <iconify-icon icon="material-symbols:warning" class="me-2"></iconify-icon>
                      <strong>Important:</strong> After submitting your order, you'll be redirected to WhatsApp where you'll need to attach this screenshot manually.
                    </div>
                  </div>
                </div>

                <div class="d-flex gap-3">
                  <button type="button" class="btn btn-secondary" onclick="window.history.back()">Back to Cart</button>
                  <button type="button" class="btn btn-success" id="submitOrderBtn" disabled>Submit Order</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <iconify-icon icon="material-symbols:shopping-cart" class="me-2 text-primary"></iconify-icon>
                Order Summary
              </h5>
            </div>
            <div class="card-body">
              <div id="orderSummary">
                <div class="text-center text-muted py-4">
                  <iconify-icon icon="material-symbols:shopping-cart-outline" class="fs-1 mb-3"></iconify-icon>
                  <p>Loading order details...</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="footer bg-dark text-white py-5">
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <h5>About Us</h5>
          <p>We provide top-quality IGCSE tutoring to help students achieve academic excellence.</p>
        </div>
        <div class="col-md-4">
          <h5>Contact Info</h5>
          <ul class="list-unstyled">
            <li><iconify-icon icon="material-symbols:phone"></iconify-icon> +201027500835</li>
            <li><iconify-icon icon="material-symbols:mail"></iconify-icon> random@email.com</li>
            <li><iconify-icon icon="material-symbols:location-on"></iconify-icon> Egypt, New Cairo</li>
          </ul>
        </div>
        <div class="col-md-4">
          <h5>Follow Us</h5>
          <div class="social-icons">
            <a href="#" class="text-white me-2"><iconify-icon icon="mdi:facebook"></iconify-icon></a>
            <a href="#" class="text-white me-2"><iconify-icon icon="mdi:twitter"></iconify-icon></a>
            <a href="#" class="text-white me-2"><iconify-icon icon="mdi:instagram"></iconify-icon></a>
          </div>
        </div>
      </div>
      <hr class="mt-4">
      <div class="text-center">
        <p>&copy; 2023 IG Way IGCSE Tutoring. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script src="js/jquery-1.11.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
    crossorigin="anonymous"></script>

  <script>
    // Global variables
    let cart = JSON.parse(localStorage.getItem('cart')) || [];
    
    // Fetch course data from homenocourses.html if needed
    let homenocoursesData = null;

    // Course data
    const courses = {
      mathematics: {
        title: 'IGCSE Mathematics (Extended)',
        instructor: 'Dr. Sarah Mitchell',
        board: 'Cambridge Board',
        price: '£299.00',
        originalPrice: '£399.00',
        image: 'images/teacher1.PNG'
      },
      physics: {
        title: 'IGCSE Physics',
        instructor: 'Prof. Michael Chen',
        board: 'Cambridge Board',
        price: '£279.00',
        originalPrice: '£349.00',
        image: 'images/teacher2.PNG'
      },
      english: {
        title: 'IGCSE English Language',
        instructor: 'Dr. Emily Rodriguez',
        board: 'Cambridge Board',
        price: '£249.00',
        originalPrice: '£329.00',
        image: 'images/teacher3.PNG'
      },
      chemistry: {
        title: 'IGCSE Chemistry',
        instructor: 'Dr. James Wilson',
        board: 'Cambridge Board',
        price: '£269.00',
        originalPrice: '£339.00',
        image: 'images/teacher4.PNG'
      },
      biology: {
        title: 'IGCSE Biology',
        instructor: 'Dr. Lisa Anderson',
        board: 'Cambridge Board',
        price: '£259.00',
        originalPrice: '£319.00',
        image: 'images/teacher5.PNG'
      }
    };

    // Check login state and update UI
    function checkLoginState() {
      const isLoggedIn = localStorage.getItem('userLoggedIn');
      const userName = localStorage.getItem('userName');
      
      if (isLoggedIn) {
        // Show user name in utility bar
        const userNameDisplay = document.getElementById('userNameDisplay');
        const displayUserName = document.getElementById('displayUserName');
        if (userNameDisplay && displayUserName) {
          userNameDisplay.style.display = 'block';
          displayUserName.textContent = userName || 'User';
        }
        
        // Hide login and register buttons
        const loginBtn = document.querySelector('.login-btn');
        const registerBtn = document.querySelector('.register-btn');
        
        if (loginBtn) {
          loginBtn.style.display = 'none';
        }
        
        if (registerBtn) {
          registerBtn.style.display = 'none';
        }
        
        console.log('✅ User logged in - Login and Register buttons hidden');
      } else {
        // Hide user name
        const userNameDisplay = document.getElementById('userNameDisplay');
        if (userNameDisplay) {
          userNameDisplay.style.display = 'none';
        }
        
        // Show login and register buttons
        const loginBtn = document.querySelector('.login-btn');
        const registerBtn = document.querySelector('.register-btn');
        
        if (loginBtn) {
          loginBtn.style.display = 'inline-block';
        }
        
        if (registerBtn) {
          registerBtn.style.display = 'inline-block';
        }
      }
    }

    // Logout function
    function logout() {
      localStorage.removeItem('userLoggedIn');
      localStorage.removeItem('userName');
      localStorage.removeItem('userEmail');
      localStorage.removeItem('authToken');
      localStorage.removeItem('userId');
      localStorage.removeItem('enrolledCourses');
      window.location.href = 'index.html';
    }

    // Immediately hide buttons if logged in (before DOM loads)
    if (localStorage.getItem('userLoggedIn')) {
      const style = document.createElement('style');
      style.textContent = '.login-btn, .register-btn { display: none !important; }';
      document.head.appendChild(style);
      console.log('🔒 User already logged in - hiding auth buttons immediately');
    }

    // Fetch course data from API
    async function fetchCourseData() {
      try {
        const response = await fetch('http://localhost:3000/api/courses');
        if (response.ok) {
          const data = await response.json();
          homenocoursesData = data;
          console.log('Fetched course data:', homenocoursesData);
        }
      } catch (error) {
        console.error('Error fetching course data:', error);
        // Fallback to hardcoded data
        homenocoursesData = [
          {
            id: 115,
            title: 'IGCSE Mathematics (Extended)',
            instructor: 'Dr. Sarah Mitchell',
            board: 'Cambridge Board',
            price: 299.00,
            image: 'images/teacher1.PNG',
            subject: 'mathematics'
          },
          {
            id: 116,
            title: 'IGCSE Physics (Extended)',
            instructor: 'Prof. Michael Chen',
            board: 'Cambridge Board',
            price: 289.00,
            image: 'images/teacher2.PNG',
            subject: 'physics'
          },
          {
            id: 117,
            title: 'IGCSE English Language',
            instructor: 'Dr. Emily Rodriguez',
            board: 'Cambridge Board',
            price: 279.00,
            image: 'images/teacher3.PNG',
            subject: 'english'
          }
        ];
        console.log('Using fallback course data:', homenocoursesData);
      }
    }

    // Get course by ID from fetched data or fallback
    function getCourseById(courseId) {
      console.log('getCourseById called with:', courseId, 'homenocoursesData:', homenocoursesData);
      if (homenocoursesData) {
        const course = homenocoursesData.find(c => c.id == courseId);
        console.log('Found course in homenocoursesData:', course);
        if (course) {
          const result = {
            title: course.title,
            instructor: course.instructor,
            board: course.board || 'Cambridge Board',
            price: `£${course.price.toFixed(2)}`,
            image: course.image || 'images/teacher1.PNG'
          };
          console.log('Returning course data:', result);
          return result;
        }
      }
      console.log('No course found for ID:', courseId);
      return null;
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('Checkout page loaded');
      console.log('Cart from localStorage:', JSON.parse(localStorage.getItem('cart')) || []);
      
      // Check login state
      checkLoginState();
      
      // Fetch course data
      await fetchCourseData();
      
      console.log('Cart items:', cart);
      console.log('Homenocourses data loaded:', homenocoursesData);
      console.log('Testing getCourseById with 115:', getCourseById('115'));
      
      if (cart.length === 0) {
        // Redirect to home if cart is empty
        window.location.href = 'index.html';
        return;
      }
      
      updateOrderSummary();
      console.log('updateOrderSummary called, checking if orderSummary element exists:', document.getElementById('orderSummary'));
      setupCheckoutEventListeners();
    });

    function updateOrderSummary() {
      const orderSummary = document.getElementById('orderSummary');
      let total = 0;
      
      const summaryHTML = cart.map(item => {
        console.log('Processing cart item:', item);
        console.log('Looking for course with ID:', item.courseId);
        
        // Handle multiple cases: course data directly in item, numeric ID, or string ID
        let course;
        if (item.title) {
          // Course data is directly in the cart item (from homenocourses.html)
          course = {
            title: item.title,
            instructor: item.instructor,
            board: item.board || 'Cambridge Board',
            price: item.price ? `£${item.price.toFixed(2)}` : '£299.00',
            image: item.image || 'images/teacher1.PNG'
          };
          console.log('Using course data from cart item:', course);
        } else {
          // Try to get course by numeric ID first (from homenocourses.html)
          course = getCourseById(item.courseId);
          if (!course) {
            // Fallback to string-based lookup (legacy)
            course = courses[item.courseId];
            console.log('Found course from string lookup:', course);
          } else {
            console.log('Found course from numeric ID lookup:', course);
          }
          
          if (!course) {
            console.log('Course not found for ID:', item.courseId);
            return '';
          }
        }
        
        const priceValue = course.price ? parseFloat(course.price.replace('£', '')) : item.price || 299.00;
        const itemTotal = priceValue * item.quantity;
        total += itemTotal;
        
        return `
          <div class="d-flex justify-content-between align-items-center mb-3 p-3 border rounded">
            <div class="d-flex align-items-center">
              <img src="${course.image}" alt="${course.title}" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;">
              <div>
                <div class="fw-bold text-primary">${course.title}</div>
                <div class="text-muted small">${course.instructor} - ${course.board}</div>
              </div>
            </div>
            <div class="text-end">
              <div class="fw-bold">£${itemTotal.toFixed(2)}</div>
            </div>
          </div>
        `;
      }).join('') + `
        <hr>
        <div class="d-flex justify-content-between align-items-center fw-bold fs-5">
          <span>Total</span>
          <span class="text-primary">£${total.toFixed(2)}</span>
        </div>
      `;
      
      console.log('Generated summaryHTML:', summaryHTML);
      console.log('Order summary element:', orderSummary);
      orderSummary.innerHTML = summaryHTML;
      
      // Update payment amounts
      document.getElementById('instapayAmount').textContent = `£${total.toFixed(2)}`;
      document.getElementById('vodafoneAmount').textContent = `£${total.toFixed(2)}`;
    }

    function setupCheckoutEventListeners() {
      // Payment method change
      document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
        radio.addEventListener('change', function() {
          updatePaymentDetails();
        });
      });

      // Submit order button
      document.getElementById('submitOrderBtn').addEventListener('click', function() {
        console.log('Submit button clicked');
        submitOrder();
      });
    }

    function updatePaymentDetails() {
      const paymentDetails = document.getElementById('paymentDetails');
      const screenshotUpload = document.getElementById('screenshotUpload');
      const instapayDetails = document.getElementById('instapayDetails');
      const vodafoneCashDetails = document.getElementById('vodafoneCashDetails');
      const submitOrderBtn = document.getElementById('submitOrderBtn');
      
      const selectedPayment = document.querySelector('input[name="paymentMethod"]:checked');
      
      if (selectedPayment) {
        paymentDetails.style.display = 'block';
        screenshotUpload.style.display = 'block';
        submitOrderBtn.disabled = false;
        
        if (selectedPayment.value === 'instapay') {
          instapayDetails.style.display = 'block';
          vodafoneCashDetails.style.display = 'none';
        } else if (selectedPayment.value === 'vodafoneCash') {
          instapayDetails.style.display = 'none';
          vodafoneCashDetails.style.display = 'block';
        }
      } else {
        paymentDetails.style.display = 'none';
        screenshotUpload.style.display = 'none';
        submitOrderBtn.disabled = true;
      }
    }

    async function submitOrder() {
      console.log('submitOrder function called');
      const form = document.getElementById('checkoutForm');
      
      // Validate form
      if (!form.checkValidity()) {
        console.log('Form validation failed');
        form.reportValidity();
        return;
      }
      
      console.log('Form validation passed');
      
      // Get payment screenshot
      const screenshot = document.getElementById('paymentScreenshot').files[0];
      if (!screenshot) {
        showToast('Please upload a payment screenshot', 'warning');
        return;
      }
      
      // Get form data
      const firstName = document.getElementById('checkoutFirstName').value;
      const lastName = document.getElementById('checkoutLastName').value;
      const email = document.getElementById('checkoutEmail').value;
      const phone = document.getElementById('checkoutPhone').value;
      
      // Get order summary
      const orderItems = cart.map(item => {
        let course;
        if (item.title) {
          course = {
            title: item.title,
            price: item.price ? `£${item.price.toFixed(2)}` : '£299.00'
          };
        } else {
          course = getCourseById(item.courseId) || courses[item.courseId];
        }
        return `${course.title} - ${course.price}`;
      }).join('\n');
      
      const total = cart.reduce((sum, item) => {
        let course;
        if (item.title) {
          course = {
            price: item.price ? `£${item.price.toFixed(2)}` : '£299.00'
          };
        } else {
          course = getCourseById(item.courseId) || courses[item.courseId];
        }
        return sum + parseFloat(course.price.replace('£', ''));
      }, 0);
      
      // Get payment method
      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
      const paymentType = paymentMethod ? paymentMethod.value : 'unknown';
      
      try {
        console.log('📋 Preparing order from cart:', cart);
        
        // Prepare courses with full details for order
        const coursesForOrder = cart.map(item => {
          console.log('Processing cart item:', item);
          let course;
          let courseId;
          let courseDetails = {};
          
          if (item.title) {
            // Course data is directly in the cart item
            courseDetails = {
              title: item.title,
              instructor: item.instructor,
              board: item.board || 'Cambridge Board',
              price: item.price || 299.00,
              image: item.image || 'images/teacher1.PNG'
            };
            
            // Map course titles to numeric IDs for database
            switch(item.title.toLowerCase()) {
              case 'igcse mathematics (extended)':
              case 'igcse mathematics':
                courseId = 1;
                break;
              case 'igcse physics':
              case 'igcse physics (extended)':
                courseId = 2;
                break;
              case 'igcse chemistry':
              case 'igcse chemistry (extended)':
                courseId = 3;
                break;
              case 'igcse english language':
              case 'english':
                courseId = 4;
                break;
              default:
                console.warn('Unknown course title, using default:', item.title);
                // Instead of returning null, assign a default ID and keep the course
                courseId = 1;
            }
          } else {
            // Handle numeric course IDs or string IDs
            if (typeof item.courseId === 'number' || !isNaN(parseInt(item.courseId))) {
              const numericId = parseInt(item.courseId);
              switch(numericId) {
                case 115:
                  courseId = 1;
                  break;
                case 116:
                  courseId = 2;
                  break;
                case 117:
                  courseId = 4;
                  break;
                default:
                  console.warn('Unknown numeric course ID, using default:', item.courseId);
                  // Instead of returning null, use the item.courseId as is
                  courseId = numericId;
              }
              
              // Get course details
              course = getCourseById(item.courseId);
              if (course) {
                courseDetails = {
                  title: course.title,
                  instructor: course.instructor,
                  board: course.board,
                  price: parseFloat(course.price.replace('£', '')),
                  image: course.image
                };
              }
            } else {
              // String course ID (legacy)
              course = courses[item.courseId];
              if (!course) {
                console.error('Course not found for ID:', item.courseId);
                return null;
              }
              
              courseDetails = {
                title: course.title,
                instructor: course.instructor,
                board: course.board,
                price: parseFloat(course.price.replace('£', '')),
                image: course.image
              };
              
              switch(item.courseId) {
                case 'mathematics':
                  courseId = 1;
                  break;
                case 'physics':
                  courseId = 2;
                  break;
                case 'chemistry':
                  courseId = 3;
                  break;
                case 'english':
                  courseId = 4;
                  break;
                default:
                  console.error('Unknown course ID:', item.courseId);
                  return null;
              }
            }
          }
          
          return {
            id: courseId,
            courseId: courseId,
            ...courseDetails,
            quantity: item.quantity
          };
        }).filter(course => course !== null);
        
        // Create order in database
        const orderData = {
          customer_name: `${firstName} ${lastName}`,
          customer_email: email,
          customer_phone: phone,
          courses: JSON.stringify(coursesForOrder),
          total_amount: total,
          payment_method: paymentType,
          payment_screenshot: screenshot.name
        };
        
        console.log('Saving order to database:', orderData);
        
        const orderResponse = await fetch('http://localhost:3000/api/orders', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          },
          body: JSON.stringify(orderData)
        });
        
        if (orderResponse.ok) {
          const orderResult = await orderResponse.json();
          console.log('Order saved to database successfully:', orderResult);
          
          // Store order details for order processing page
          localStorage.setItem('lastOrder', JSON.stringify({
            id: orderResult.orderId,
            created_at: new Date().toISOString()
          }));
          localStorage.setItem('lastPurchasedCart', JSON.stringify(coursesForOrder));
          
          showToast('Order created successfully! Redirecting to WhatsApp...', 'success');
          
          // Create WhatsApp message with order details
          const whatsappMessage = `
🎓 *New Order from IG Nation*

*Customer Details:*
Name: ${firstName} ${lastName}
Email: ${email}
Phone: ${phone}

*Order Details:*
${orderItems}

*Total Amount:* £${total.toFixed(2)}
*Payment Method:* ${paymentType === 'instapay' ? 'Instapay' : 'Vodafone Cash'}
*Order ID:* ${orderResult.orderId}

✅ Payment screenshot will be attached separately`;
          
          // Clear cart
          cart = [];
          localStorage.setItem('cart', JSON.stringify(cart));
          
          // Redirect to WhatsApp with instructions to upload screenshot
          redirectToWhatsApp(whatsappMessage, screenshot);
          
          return;
        } else {
          const errorData = await orderResponse.json();
          console.error('Failed to save order:', errorData);
          showToast('Failed to create order. Please try again.', 'error');
          return;
        }
        
      } catch (error) {
        console.error('Error creating order:', error);
        showToast('Error creating order. Please try again.', 'error');
        return;
      }
    }

    // testRedirect function removed - no longer needed

    function redirectToWhatsApp(message, screenshot) {
      const phoneNumber = '201027500835'; // Remove + for WhatsApp URL
      const encodedMessage = encodeURIComponent(message);
      
      // Store screenshot in localStorage as data URL for user reference
      if (screenshot) {
        const reader = new FileReader();
        reader.onload = function(e) {
          localStorage.setItem('paymentScreenshot', e.target.result);
          localStorage.setItem('paymentScreenshotName', screenshot.name);
        };
        reader.readAsDataURL(screenshot);
      }
      
      // Create WhatsApp URL
      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
      
      // Show enhanced instructions modal with screenshot preview
      showWhatsAppInstructions(screenshot, whatsappUrl);
    }

    function showWhatsAppInstructions(screenshot, whatsappUrl) {
      // Create screenshot preview
      let screenshotPreview = '';
      if (screenshot) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('screenshotPreviewImg').src = e.target.result;
        };
        reader.readAsDataURL(screenshot);
        
        screenshotPreview = `
          <div class="card mt-3">
            <div class="card-header bg-light">
              <h6 class="mb-0">
                <iconify-icon icon="material-symbols:image" class="me-2"></iconify-icon>
                Your Payment Screenshot
              </h6>
            </div>
            <div class="card-body text-center">
              <img id="screenshotPreviewImg" src="" alt="Payment Screenshot" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 5px;">
              <p class="mt-2 text-muted small">
                <iconify-icon icon="material-symbols:info"></iconify-icon>
                Please attach this screenshot when you open WhatsApp
              </p>
              <button class="btn btn-sm btn-outline-primary" onclick="downloadScreenshot()">
                <iconify-icon icon="material-symbols:download"></iconify-icon>
                Download Screenshot
              </button>
            </div>
          </div>
        `;
      }
      
      // Create modal for instructions
      const modalHtml = `
        <div class="modal fade" id="whatsappInstructionsModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                  <iconify-icon icon="logos:whatsapp-icon" class="me-2"></iconify-icon>
                  Complete Your Order via WhatsApp
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="alert alert-success">
                  <h6><iconify-icon icon="material-symbols:check-circle" class="me-2"></iconify-icon>Order Submitted Successfully!</h6>
                  <p class="mb-0">Now let's send your payment proof to our team.</p>
                </div>
                
                <div class="alert alert-info">
                  <h6><iconify-icon icon="material-symbols:info" class="me-2"></iconify-icon>Next Steps:</h6>
                  <ol class="mb-0">
                    <li>Click the <strong>"Open WhatsApp"</strong> button below</li>
                    <li>Your order details will be pre-filled in the message</li>
                    <li><strong>Click the attachment icon (📎) in WhatsApp</strong></li>
                    <li><strong>Attach your payment screenshot</strong> from your device</li>
                    <li>Send the message to complete your order</li>
                  </ol>
                </div>
                
                ${screenshotPreview}
                
                <div class="text-center mt-4">
                  <p class="mb-3">
                    <iconify-icon icon="logos:whatsapp-icon" style="font-size: 24px;"></iconify-icon>
                    <br>
                    <strong>WhatsApp Number:</strong> +201027500835
                  </p>
                  <button class="btn btn-success btn-lg" onclick="window.open('${whatsappUrl}', '_blank')">
                    <iconify-icon icon="logos:whatsapp-icon" class="me-2"></iconify-icon>
                    Open WhatsApp Now
                  </button>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="window.location.href='index.html'">
                  Close & Go Home
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
      
      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      
      // Show modal
      const modal = new bootstrap.Modal(document.getElementById('whatsappInstructionsModal'));
      modal.show();
      
      // Cleanup when modal is closed
      document.getElementById('whatsappInstructionsModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
      });
    }
    
    function downloadScreenshot() {
      const screenshotData = localStorage.getItem('paymentScreenshot');
      const screenshotName = localStorage.getItem('paymentScreenshotName') || 'payment-screenshot.png';
      
      if (screenshotData) {
        const link = document.createElement('a');
        link.href = screenshotData;
        link.download = screenshotName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('Screenshot downloaded!', 'success');
      }
    }

    function openWhatsAppDirectly() {
      const phoneNumber = '201027500835'; // Remove + for WhatsApp URL
      const message = `🎓 *IG Way IGCSE Tutoring - Course Purchase Confirmation*

👤 *Student Details:*
• Name: ${document.getElementById('checkoutFirstName').value} ${document.getElementById('checkoutLastName').value}
• Email: ${document.getElementById('checkoutEmail').value}
• Phone: ${document.getElementById('checkoutPhone').value}

📚 *Courses Purchased:*
${cart.map(item => {
  const course = courses[item.courseId];
  return `${course.title} - ${course.price}`;
}).join('\n')}

💰 *Total Amount: £${cart.reduce((sum, item) => {
  const course = courses[item.courseId];
  return sum + parseFloat(course.price.replace('£', ''));
}, 0).toFixed(2)}*

📸 *Payment Screenshot Attached*

Please verify the payment and activate my courses. Thank you!`;
      
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
      
      window.open(whatsappUrl, '_blank');
    }

    function showToast(message, type = 'info') {
      const toastContainer = document.getElementById('toastContainer');
      const toastId = 'toast-' + Date.now();
      
      let icon = 'material-symbols:info';
      let title = 'Notification';
      let bgClass = 'bg-primary';
      
      if (type === 'warning') {
        icon = 'material-symbols:warning';
        title = 'Warning!';
        bgClass = 'bg-warning';
      } else if (type === 'success') {
        icon = 'material-symbols:check-circle';
        title = 'Success!';
        bgClass = 'bg-success';
      }
      
      const toastHTML = `
        <div class="toast" id="${toastId}" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header ${bgClass} text-white">
            <iconify-icon icon="${icon}" class="me-2"></iconify-icon>
            <strong class="me-auto">${title}</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;
      
      toastContainer.insertAdjacentHTML('beforeend', toastHTML);
      
      const toastElement = document.getElementById(toastId);
      const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: 3000
      });
      
      toast.show();
      
      toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
      });
    }
  </script>
</body>
</html>

< ! - -   C a c h e   b u s t :   2 0 2 5 1 0 0 8 1 6 4 0 2 4   - - > 
 
 