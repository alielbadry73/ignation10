<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirecting...</title>
    <script src="js/api.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
        }
        .loader {
            text-align: center;
            color: white;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h2 {
            margin: 0 0 10px;
        }
        p {
            margin: 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="loader">
        <div class="spinner"></div>
        <h2>Redirecting to your dashboard...</h2>
        <p id="statusMessage">Checking your courses...</p>
    </div>

    <script>
        async function redirectToCourseDashboard() {
            const statusMessage = document.getElementById('statusMessage');
            
            try {
                statusMessage.textContent = 'Loading your course information...';
                
                // Get user email from localStorage
                const userEmail = localStorage.getItem('userEmail');
                console.log('🔍 User email:', userEmail);
                
                if (!userEmail) {
                    console.log('❌ No user email found, redirecting to home');
                    statusMessage.textContent = 'No user session found...';
                    setTimeout(() => {
                        window.location.href = 'homenocourses.html';
                    }, 1000);
                    return;
                }
                
                // Fetch user's approved orders by email
                statusMessage.textContent = 'Checking your purchased courses...';
                const response = await fetch(`http://localhost:3000/api/orders/by-email/${encodeURIComponent(userEmail)}`);
                
                if (!response.ok) {
                    console.log('❌ Failed to fetch orders, redirecting to home');
                    statusMessage.textContent = 'Unable to load courses...';
                    setTimeout(() => {
                        window.location.href = 'homenocourses.html';
                    }, 1000);
                    return;
                }
                
                const data = await response.json();
                const orders = data.orders || [];
                
                console.log('📋 Found orders:', orders);
                
                if (orders.length === 0) {
                    console.log('📝 No approved orders found, redirecting to homenocourses');
                    statusMessage.textContent = 'No courses found. Redirecting...';
                    setTimeout(() => {
                        window.location.href = 'homenocourses.html';
                    }, 1000);
                    return;
                }
                
                // Check courses in each order
                for (const order of orders) {
                    try {
                        const courses = typeof order.courses === 'string' ? JSON.parse(order.courses) : order.courses;
                        console.log('📚 Checking courses:', courses);
                        
                        if (Array.isArray(courses)) {
                            // Handle array of course objects or strings
                            const courseNames = courses.map(c => 
                                typeof c === 'string' ? c : (c.title || c.name || '')
                            );
                            
                            console.log('📖 Course names:', courseNames);
                            
                            // Check for English
                            if (courseNames.some(name => name && name.toLowerCase().includes('english'))) {
                                console.log('✅ English course found, redirecting to English dashboard');
                                statusMessage.textContent = 'Redirecting to English dashboard...';
                                setTimeout(() => {
                                    window.location.href = 'english-dashboard.html';
                                }, 500);
                                return;
                            }
                            
                            // Check for Mathematics
                            if (courseNames.some(name => name && (name.toLowerCase().includes('mathematics') || name.toLowerCase().includes('math')))) {
                                console.log('✅ Mathematics course found, redirecting to Mathematics dashboard');
                                statusMessage.textContent = 'Redirecting to Mathematics dashboard...';
                                setTimeout(() => {
                                    window.location.href = 'mathematics-dashboard.html';
                                }, 500);
                                return;
                            }
                            
                            // Check for Physics
                            if (courseNames.some(name => name && name.toLowerCase().includes('physics'))) {
                                console.log('✅ Physics course found, redirecting to Physics dashboard');
                                statusMessage.textContent = 'Redirecting to Physics dashboard...';
                                setTimeout(() => {
                                    window.location.href = 'physics-dashboard.html';
                                }, 500);
                                return;
                            }
                        } else if (typeof courses === 'string') {
                            // Handle single course string
                            console.log('📖 Course string:', courses);
                            
                            if (courses.toLowerCase().includes('english')) {
                                console.log('✅ English course found, redirecting to English dashboard');
                                statusMessage.textContent = 'Redirecting to English dashboard...';
                                setTimeout(() => {
                                    window.location.href = 'english-dashboard.html';
                                }, 500);
                                return;
                            }
                            
                            if (courses.toLowerCase().includes('mathematics') || courses.toLowerCase().includes('math')) {
                                console.log('✅ Mathematics course found, redirecting to Mathematics dashboard');
                                statusMessage.textContent = 'Redirecting to Mathematics dashboard...';
                                setTimeout(() => {
                                    window.location.href = 'mathematics-dashboard.html';
                                }, 500);
                                return;
                            }
                            
                            if (courses.toLowerCase().includes('physics')) {
                                console.log('✅ Physics course found, redirecting to Physics dashboard');
                                statusMessage.textContent = 'Redirecting to Physics dashboard...';
                                setTimeout(() => {
                                    window.location.href = 'physics-dashboard.html';
                                }, 500);
                                return;
                            }
                        }
                    } catch (parseError) {
                        console.error('❌ Error parsing courses for order:', order.id, parseError);
                    }
                }
                
                // No specific course found
                console.log('📝 No specific course identified, redirecting to homenocourses');
                statusMessage.textContent = 'No courses identified. Redirecting...';
                setTimeout(() => {
                    window.location.href = 'homenocourses.html';
                }, 1000);
                
            } catch (error) {
                console.error('❌ Error during redirect:', error);
                statusMessage.textContent = 'Error occurred. Redirecting to home...';
                setTimeout(() => {
                    window.location.href = 'homenocourses.html';
                }, 1500);
            }
        }
        
        // Execute redirect when page loads
        window.addEventListener('DOMContentLoaded', redirectToCourseDashboard);
    </script>
</body>
</html>

